{% extends "base.html" %}
{% block title %}TRAX{% endblock %}
{% block head %}
{{ super() }}
{% endblock %}
{% block body %}
{{ super() }}
<div class="row">
    <div class="col-md-2">
        <div id="hidenav">&nbsp;</div>
        <div id="tagfilter"></div>
    </div>
    <div class="col-md-10">
        <div class="row ">
            <div class="col-md-6">
                <h5>
                    <span class="label label-default suggested">Suggested events</span>
                    <span class="label label-warning followedup">Pending events</span>
                    <span class="label label-success approved">Approved events</span>
                    {% if user is not none and user.staff == 1 %}
                    <span class="label label-danger rejected">Rejected events</span>
                    {% endif %}
                </h5>
            </div>
            <div class="col-md-6 text-right">
                <button id="createeventbutton" class="btn btn-primary">Create an event</button>
            </div>

        </div>
        <div class="row">
            <div class="col-md-12 submissions-list">
                <div id="info"></div>
                <form action="/rsvp" method=post>
                    {% for submission in submissions %}
                    {{ macros.event_summary(submission, user) }}
                    {% endfor %}
                </form>
                <div class="oops hidden">Oops! There are no events with that tag. Maybe you could <a href="form.html">create one</a>?</div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
{% block page_script %}
{{ super() }}
<script type="text/javascript">

    var tagList = [],view,data;
    var tags = "{% for tag in tags %}{{tag}},{% endfor%}".split(",");

    tags = tags.slice(0,tags.length -1);

    can.each(tags,function(tag){
        tagList.push({
            name : tag,
            excluded: false,
            included : true
        });
    });

    data = new can.Map({
        infoText : "",
        all : true,
        tags : tagList
    });

    view = can.view("{{ url_for('static', filename='tagfilter.mustache') }}",data);

    //Handle collapsing and expanding the navigation

    $("#hidenav").click(function () {
        if ($("#leftmenu .tag").is(":hidden")) {
            //$('#hidenav').prependTo('#leftmenu');
            $("#leftmenu .tag").show('slow');
            $("#masthead, #report").addClass('withmenu');
        } else {
            //$('#hidenav').prependTo('body');
            $("#leftmenu .tag").hide('slow');
            $("#masthead, #report").removeClass('withmenu');
        }
    });

    var TagFilter = can.Control.extend({

        init : function(){
            this.options.viewModel = data;
            this.element.html(view);
            this.on();
        },

        //set the tag button state, updates the data object
        ".btn click" : function(el){
            var self = this;
            var tag = el.data('tag');
            var tagList = data.tags;
            var all = data.attr('all');

            //look up the tag object
            var t = _.find(tagList,{name : tag});

            //user clicked a tag button
            if(t){
                can.batch.start();
                //if all is true, reset everything to false and just pick this one thing
                if(all){
                    data.attr('all',false);
                    _.forEach(tagList,function(tag){
                        tag.attr('included',false);
                        tag.attr('excluded',false);
                    });
                }

                if(t.attr('included')){
                    t.attr('included',false);
                    t.attr('excluded',true);
                }else if(t.attr('excluded')){
                    t.attr('excluded',false);
                    t.attr('included',false);
                }else{
                    t.attr('included',true);
                }

                can.batch.stop();
            }else{
                //all
                data.attr('all',!all);

                can.batch.start();
                _.forEach(tagList,function(tagBtn){
                    //toggle all state
                    tagBtn.attr('excluded',false);
                    tagBtn.attr('included',data.attr('all'));
                });
                can.batch.stop();
            }

            var included = _.filter(tagList,"included");
            var excluded = _.filter(tagList,"excluded");

            //TODO upate the text

        }

    });

    new TagFilter("#tagfilter");

    //TODO add the event list widget

    $("#createeventbutton").click(function(){
       document.location.href="/eventform"
    });

    /*$('.tagfilter button').click(function (ev) {

        var $el = $(ev.target);
        var tag = $el.data('tag');
        var $tagBtns = $('.tagfilter button');
        var $submissions = $('.submission');
        var subsHidden = 0;

        //clean up the clicked tag buttons
        $tagBtns.removeClass('active');
        $el.addClass('active');

        if(tag){

            $submissions.each(function (idx,el) {
                var $el = $(el);
                var subTag = $el.data('tags');

                if(subTag === tag){
                    $el.removeClass('hidden');
                }else{
                    $el.addClass('hidden');
                    subsHidden += 1;
                }

            });
        }else{
            $submissions.removeClass('hidden');
        }

        if(subsHidden === $submissions.length){
            $(".submissions-list .oops").removeClass('hidden');
        }else{
            $(".submissions-list .oops").addClass('hidden');
        }

    });*/


    // Handle clicking on tags.
    /*var included = [];
    var excluded = [];

    $('.tagfilter button').click(function(ev) {

        var $el = $(ev.target);
        var tagname = $el.data('tag');
        var $submissions = $('.submission');
        var state = $el.data('state');

        // Toggle tags between active,exclude,off;
       if ($el.hasClass('active')) {
            if (tagname) {
                $el.removeClass('include').addClass('exclude');
                included.splice(included.indexOf(tagname), 1);
                excluded.push(tagname);
            } else {

                included = [];
                excluded = [];
            }
        } else if ($el.hasClass('exclude')) {
            $el.removeClass('exclude').addClass('off');
            excluded.splice(excluded.indexOf(tagname), 1);
        }else{
           if (tagname) {
               $el.removeClass('off').addClass('include');
               included.push(tagname);
           } else {
               $('.off').add('.exclude').addClass('include').removeClass('off exclude');
               excluded = [];
               included = [];
               $('.include').each(function (i, thetag) {
                   included.push($(thetag).text());
               });
           }
       }

        // Show or hide the appropriate events
        if($('.include').length == 0) { $('#report').hide('slow');
        } else { $('#report').show('slow'); }

        $(included).each(function (i, thetag) {
            $('.'+thetag).show('slow');
        });
        $(excluded).each(function (i, thetag) {
            $('.'+thetag).hide(); });

        // Tell the user what they just did.
        if (included.length > 0 && excluded.length == 0) {
            $("#info").text("Show "+included.join(", ")+" events ("+$('.event:visible').length+" events total).");
            if ($('.event:visible').length == 0) {
                $('#oops').show();
            } else {
                $('#oops').hide();
            }
        } else if (included.length == 0 && excluded.length > 0) {
            $("#info").text("Hide "+excluded.join(", ")+" events. No tags selected to view.");
        } else if (included.length > 0 && excluded.length > 0) {
            $("#info").text("Show "+included.join(", ")+" events unless they are also "+excluded.join(", ")+" events ("+$('.event:visible').length+" events total).");
        } else if (included.length == 0 && excluded.length == 0) {
            $("#info").text("All view settings cleared.");
        }

    });*/
</script>
{% endblock %}